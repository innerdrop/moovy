generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  password           String
  name               String?
  firstName          String?
  lastName           String?
  phone              String?
  role               String              @default("USER")
  emailVerified      DateTime?
  image              String?
  pointsBalance      Int                 @default(0)
  pendingBonusPoints Int                 @default(0)
  bonusActivated     Boolean             @default(false)
  referralCode       String              @unique @default(cuid())
  referredById       String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  resetToken         String?
  resetTokenExpiry   DateTime?
  deletedAt          DateTime?
  addresses          Address[]
  cart               CartItem[]
  driver             Driver?
  ownedMerchants     Merchant[]
  orders             Order[]
  pointsTransactions PointsTransaction[]
  referralsReceived  Referral?           @relation("ReferralReferee")
  referralsMade      Referral[]          @relation("ReferralReferrer")
  supportChats       SupportChat[]       @relation("UserSupportChats")
  sentSupportMsgs    SupportMessage[]    @relation("SupportMessageSender")
  referredBy         User?               @relation("UserReferrals", fields: [referredById], references: [id])
  referredUsers      User[]              @relation("UserReferrals")
}

model Address {
  id           String    @id @default(cuid())
  userId       String
  label        String
  street       String
  number       String
  apartment    String?
  neighborhood String?
  city         String    @default("Ushuaia")
  province     String    @default("Tierra del Fuego")
  zipCode      String?
  latitude     Float?
  longitude    Float?
  isDefault    Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders       Order[]
}

model Category {
  id                      String            @id @default(cuid())
  name                    String            @unique
  slug                    String            @unique
  description             String?
  image                   String?
  isActive                Boolean           @default(true)
  order                   Int               @default(0)
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  allowIndividualPurchase Boolean           @default(true)
  price                   Float             @default(0)
  products                ProductCategory[]
  merchants               MerchantCategory[]
}


model Product {
  id          String            @id @default(cuid())
  name        String
  slug        String            @unique
  description String?
  merchantId  String?
  price       Float
  costPrice   Float
  stock       Int               @default(0)
  minStock    Int               @default(5)
  isActive    Boolean           @default(true)
  isFeatured  Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  cartItems   CartItem[]
  orderItems  OrderItem[]
  merchant    Merchant?         @relation(fields: [merchantId], references: [id])
  categories  ProductCategory[]
  images      ProductImage[]
  variants    ProductVariant[]
}

model ProductCategory {
  id         String   @id @default(cuid())
  productId  String
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  alt       String?
  order     Int     @default(0)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  name      String
  price     Float?
  stock     Int     @default(0)
  isActive  Boolean @default(true)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  quantity  Int      @default(1)
  variantId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, variantId])
}

model Order {
  id                  String      @id @default(cuid())
  orderNumber         String      @unique
  userId              String
  addressId           String
  merchantId          String?
  status              String      @default("PENDING")
  paymentId           String?
  paymentStatus       String      @default("PENDING")
  paymentMethod       String?
  subtotal            Float
  deliveryFee         Float       @default(0)
  discount            Float       @default(0)
  total               Float
  distanceKm          Float?
  deliveryNotes       String?
  estimatedTime       Int?
  driverId            String?
  deliveryStatus      String?
  deliveredAt         DateTime?
  deliveryPhoto       String?
  customerNotes       String?
  adminNotes          String?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  cancelReason        String?
  commissionPaid      Boolean     @default(false)
  driverRating        Int?
  merchantPayout      Float?      @default(0)
  moovyCommission     Float?      @default(0)
  ratedAt             DateTime?
  ratingComment       String?
  assignmentAttempts  Int         @default(0)
  assignmentExpiresAt DateTime?
  attemptedDriverIds  String?
  lastAssignmentAt    DateTime?
  pendingDriverId     String?
  address             Address     @relation(fields: [addressId], references: [id])
  driver              Driver?     @relation(fields: [driverId], references: [id])
  merchant            Merchant?   @relation(fields: [merchantId], references: [id])
  user                User        @relation(fields: [userId], references: [id])
  items               OrderItem[]
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  productId   String
  name        String
  price       Float
  quantity    Int
  variantName String?
  subtotal    Float
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product @relation(fields: [productId], references: [id])
}

model Merchant {
  id               String                    @id @default(cuid())
  name             String
  slug             String                    @unique
  description      String?
  image            String?
  banner           String?
  isActive         Boolean                   @default(true)
  isOpen           Boolean                   @default(true)
  isVerified       Boolean                   @default(false)
  email            String?
  phone            String?
  address          String?
  latitude         Float?
  longitude        Float?
  deliveryRadiusKm Float                     @default(5)
  deliveryTimeMin  Int                       @default(30)
  deliveryTimeMax  Int                       @default(45)
  deliveryFee      Float                     @default(0)
  minOrderAmount   Float                     @default(0)
  cuit             String?
  category         String?                   @default("Otro")
  ownerId          String
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  adminNotes       String?
  bankAccount      String?
  businessName     String?
  commissionRate   Float                     @default(8)
  cuil             String?
  displayOrder     Int                       @default(0)
  facebookUrl      String?
  instagramUrl     String?
  isPremium        Boolean                   @default(false)
  ownerBirthDate   DateTime?
  ownerDni         String?
  premiumTier      String?                   @default("basic")
  premiumUntil     DateTime?
  startedAt        DateTime?
  whatsappNumber   String?
  ubicacion        Unsupported("geography")?
  owner             User                      @relation(fields: [ownerId], references: [id])
  orders            Order[]
  products          Product[]
  acquiredPackages  MerchantCategory[]
}

model MerchantCategory {
  id         String   @id @default(cuid())
  merchantId String
  categoryId String
  createdAt  DateTime @default(now())

  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([merchantId, categoryId])
}


model Driver {
  id                 String                    @id @default(cuid())
  userId             String                    @unique
  vehicleType        String?
  vehicleBrand       String?
  vehicleModel       String?
  vehicleYear        Int?
  vehicleColor       String?
  licensePlate       String?
  isActive           Boolean                   @default(true)
  isOnline           Boolean                   @default(false)
  totalDeliveries    Int                       @default(0)
  rating             Float?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  availabilityStatus String                    @default("FUERA_DE_SERVICIO")
  lastLocationAt     DateTime?
  latitude           Float?
  longitude          Float?
  ubicacion          Unsupported("geography")?
  user               User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders             Order[]
}

model StoreSettings {
  id                    String   @id @default("settings")
  isOpen                Boolean  @default(true)
  closedMessage         String   @default("Estamos cerrados. ??Volvemos pronto!")
  isMaintenanceMode     Boolean  @default(false)
  maintenanceMessage    String   @default("??Volvemos pronto! Estamos trabajando para mejorar tu experiencia.")
  fuelPricePerLiter     Float    @default(1200)
  fuelConsumptionPerKm  Float    @default(0.06)
  baseDeliveryFee       Float    @default(500)
  maintenanceFactor     Float    @default(1.35)
  freeDeliveryMinimum   Float?
  maxDeliveryDistance   Float    @default(15)
  storeName             String   @default("Moovy Ushuaia")
  storeAddress          String   @default("Ushuaia, Tierra del Fuego")
  originLat             Float    @default(-54.8019)
  originLng             Float    @default(-68.3030)
  whatsappNumber        String?
  phone                 String?
  email                 String?
  schedule              String?
  updatedAt             DateTime @updatedAt
  promoPopupButtonText  String?  @default("Ver m??s")
  promoPopupDismissable Boolean  @default(true)
  promoPopupEnabled     Boolean  @default(false)
  promoPopupImage       String?
  promoPopupLink        String?
  promoPopupMessage     String?
  promoPopupTitle       String?
  showComerciosCard     Boolean  @default(true)
  showRepartidoresCard  Boolean  @default(true)
  tiendaMaintenance     Boolean  @default(false)
  maxCategoriesHome     Int      @default(6)
}

model PointsConfig {
  id                   String   @id @default("points_config")
  pointsPerDollar      Float    @default(1)
  minPurchaseForPoints Float    @default(0)
  pointsValue          Float    @default(0.01)
  minPointsToRedeem    Int      @default(100)
  maxDiscountPercent   Float    @default(50)
  signupBonus          Int      @default(100)
  referralBonus        Int      @default(200)
  reviewBonus          Int      @default(10)
  pointsExpireDays     Int?
  updatedAt            DateTime @updatedAt
}

model PointsTransaction {
  id           String   @id @default(cuid())
  userId       String
  orderId      String?
  type         String
  amount       Int
  balanceAfter Int
  description  String?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Referral {
  id             String   @id @default(cuid())
  referrerId     String
  refereeId      String   @unique
  codeUsed       String
  referrerPoints Int      @default(50)
  refereePoints  Int      @default(100)
  status         String   @default("COMPLETED")
  createdAt      DateTime @default(now())
  referee        User     @relation("ReferralReferee", fields: [refereeId], references: [id], onDelete: Cascade)
  referrer       User     @relation("ReferralReferrer", fields: [referrerId], references: [id], onDelete: Cascade)
}

model SavedCart {
  id         String   @id @default(cuid())
  userId     String   @unique
  items      Json
  merchantId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model SupportChat {
  id            String           @id @default(cuid())
  userId        String
  merchantId    String?
  subject       String?
  status        String           @default("open")
  lastMessageAt DateTime         @default(now())
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  user          User             @relation("UserSupportChats", fields: [userId], references: [id], onDelete: Cascade)
  messages      SupportMessage[]
}

model SupportMessage {
  id          String      @id @default(cuid())
  chatId      String
  senderId    String
  content     String
  isFromAdmin Boolean     @default(false)
  isRead      Boolean     @default(false)
  createdAt   DateTime    @default(now())
  chat        SupportChat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender      User        @relation("SupportMessageSender", fields: [senderId], references: [id])
}

model OrderBackup {
  id          String   @id @default(cuid())
  backupName  String
  orderData   String
  orderId     String?
  orderNumber String?
  total       Float?
  deletedBy   String?
  deletedAt   DateTime @default(now())
  createdAt   DateTime @default(now())
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}
